{% extends 'base.html' %}


{% block content %}
{% load custom_tags %}

    <div class="row">
        
        <div class="aside col-4 border">
            <h3>Category Attrs</h3>
            <ul>
                <li>
                    Цена, руб.
                </li>
                    <div class="input-group">
                        <input
                            class="price-attrs form-control rounded"
                            name="price-min"
                            {% if price_dict|from_dict:'price'|from_list:0 %}
                                value="{{ price_dict|from_dict:'price'|from_list:0 }}"
                            {% else %}
                                value=""
                            {% endif %}
                            placeholder="от"
                        >
                        <input
                            class="price-attrs form-control mx-1 rounded"
                            name="price-max"
                            {% if price_dict|from_dict:'price'|from_list:1 %}
                                value="{{ price_dict|from_dict:'price'|from_list:1 }}"
                            {% else %}
                                value=""
                            {% endif %}
                            placeholder="до"
                        >
                    </div>
                    <br>

                <li>
                    Производитель
                </li>
                    {% for brand in brands %}
                        {% with 'brand'|addstr:brand.brand as value %}
                        <input 
                            class="brand-attrs"
                            type="checkbox"
                            name="{{ value }}"
                            value="{{ value }}"
                            {% if brand.brand in brand_dict.brand %}
                                checked
                            {% else %}
                            {% endif %}
                        >
                        <label for="{{ value }}">{{ brand.brand }}</label><br>
                        {% endwith %}
                    {% endfor %}
                    <br>

                {% for attr in category_attrs %}
                <li>
                   {{ attr.name }}:
                </li>
                    {% if attr.filter_type == 'range' %}
                        <div class="input-group">
                            {% with attr.name as name %}
                            <input
                                class="range-attrs form-control rounded"
                                name="{{ name }}-min"
                                {% if range_filter_dict|from_dict:name|from_list:0 %}
                                    value="{{ range_filter_dict|from_dict:name|from_list:0 }}"
                                {% else %}
                                    value=""
                                {% endif %}
                                placeholder="от"
                            >
                            <input
                                class="range-attrs form-control mx-1 rounded"
                                name="{{ name }}-max"
                                {% if range_filter_dict|from_dict:name|from_list:1 %}
                                    value="{{ range_filter_dict|from_dict:name|from_list:1 }}"
                                {% else %}
                                    value=""
                                {% endif %}
                                placeholder="до"
                            >
                            {% endwith %}
                        </div>
                        <br>

                    {% else %}

                    {% for val in attr_values %}
                    {% if val.product_attribute__name == attr.name %}
                        {% with attr.name|addstr:val.value as value %}
                        
                        <input 
                            class="checkbox-attrs"
                            type="checkbox"
                            name="{{ value }}"
                            value="{{ value }}"
                            {% if value in checkbox_arguments %}
                            checked
                            {% else %}
                            {% endif %}
                        >
                        <label for="{{ value }}">{{ val.value }}</label><br>
                        {% endwith %}
                    {% endif %}
                    {% endfor %}
                    <br>

                    {% endif %}

                {% endfor %}
            </ul>

            <form id="attrs" method="post">
                {% csrf_token %}
            </form>

            <div class="submit btn btn-primary">Filter</div>

            <a class="btn btn-secondary"
               href="{% url 'inventory:product_by_category' category_slug=category.slug %}"
            >Reset Filters</a>

        </div>

        <div class="col-8">
            <div class="tree mb-2">
                {% for ancestor in category.get_ancestors %}
                    <a  href="{% url 'inventory:category' category_slug=ancestor.slug %}"
                        class="badge bg-light text-secondary border text-decoration-none"
                    >{{ ancestor.name }}</a><span class="text-secondary"> / </span>
                {% endfor %}
                <a href="#" 
                    class="badge bg-light text-secondary border text-decoration-none"
                >{{ category.name }}</a>
            </div>

            <h1>Products</h1>
            <h2><small>in</small> {{ category.name }}</h2>
            <ul>
            {% for product in products %}
                <li>
                    <a href="{% url "inventory:product_detail" product_slug=product.slug %}">{{ product.name }}</a><br>
                    {{ product.id }}<br>
                    {{ product.description }}
                    {% comment %} Price: ${{ product.product__store_price }} ({{product.product__product_inventory__units}} pcs.) {% endcomment %}
                </li>
            {% endfor %}
            </ul>

        </div>

    </div>



    <script>
        let submit = document.querySelector('.submit')
        let form = document.getElementById("attrs")
        let checkboxes = document.querySelectorAll('.checkbox-attrs')
        let range_items = document.querySelectorAll('.range-attrs')
        let price_items = document.querySelectorAll('.price-attrs')
        let brand_items = document.querySelectorAll('.brand-attrs')

        submit.addEventListener('click', function(e){
            let args1 = document.createElement("input");
            let args2 = document.createElement("input");
            let args3 = document.createElement("input");
            let args4 = document.createElement("input");

            let checkbox_attrs = [];
            let range_attrs = [];
            let price_attrs = [];
            let brand_attrs = [];

            checkboxes.forEach(function(box){
                if (box.checked == true) {
                    checkbox_attrs.push(box.value);
                };
            });

            brand_items.forEach(function(box){
                if (box.checked == true) {
                    brand_attrs.push(box.value);
                };
            });
            
            range_items.forEach(function(item){
                if (item.value != '') {
                    range_attrs.push(item.name + ':' + item.value);
                } 
            });
            
            price_items.forEach(function(item){
                if (item.value != '') {
                    price_attrs.push(item.name + ':' + item.value);
                } 
            });
            
            args1.setAttribute("type", "hidden");
            args1.setAttribute("name", "checkbox_attrs");
            args1.setAttribute("value", checkbox_attrs.join('&'));

            args2.setAttribute("type", "hidden");
            args2.setAttribute("name", "range_attrs");
            args2.setAttribute("value", range_attrs.join('&'));

            args3.setAttribute("type", "hidden");
            args3.setAttribute("name", "price_attrs");
            args3.setAttribute("value", price_attrs.join('&'));

            args4.setAttribute("type", "hidden");
            args4.setAttribute("name", "brand_attrs");
            args4.setAttribute("value", brand_attrs.join('&'));

            form.appendChild(args1);
            form.appendChild(args2);
            form.appendChild(args3);
            form.appendChild(args4);

            //console.log(form);
            $('body').append(form);
            form.submit();
        });

        {% comment %} submit.addEventListener('click', function(e){
            let currentpath = document.URL;
            let formData = new FormData($('form')[0]);
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
            $.ajax({
                    url: currentpath,
                    type: 'POST',
                    data: formData,
                    cache: false,
                    contentType: false,
                    processData: false
                });
            console.log(submit);
        }); {% endcomment %}
        
    </script>

{% endblock %}